'use strict';const _0x4942=['env','toString','login','create','../repository/RepositoryFactory','subject','39OaEJtQ','randomBytes','replace','../errors/errors','523njfxXd','log','getTime','verified','update','toUpperCase','logout','exports','226pRDJjW','JWT_SECRET','<%USERNAME%>','User\x20id\x20','retrieve','21833XqTiJd','30d','Session','User','deleteByFilter','hash','expirationDate','verifyEmail','code','queryByFilter','365zdxGwT','mapUserDto','sendMail','689855yVruup','add','User\x20email\x20','confirmationLink','queryById','./ModelMapper','insert','log_iat','Invalid\x20verification\x20code','remove','codeExpirationInterval','password','jsonwebtoken','mapUserEntity','email','now','127933CpeNIP','htmlBodyTemplate','username','Password\x20does\x20not\x20match','<%USER_ID%>','retrieveCurrent','\x20not\x20found','../config/mailing','resendVerificationEmail','Username\x20does\x20not\x20exist','VerificationCode','crypto','from','<%EMAIL%>','73087KgGbEj','986709MVPLvT','<%EXPIRATION_DATE%>','<%CODE%>','Expired\x20verification\x20code','1675clNFtl','<%CONFIRM_LINK%>'];const _0x570192=_0x4d4e;(function(_0x4db79,_0x2c5f1b){const _0x359ac3=_0x4d4e;while(!![]){try{const _0x327946=-parseInt(_0x359ac3(0x215))*parseInt(_0x359ac3(0x204))+-parseInt(_0x359ac3(0x222))+parseInt(_0x359ac3(0x1f7))+parseInt(_0x359ac3(0x208))*parseInt(_0x359ac3(0x1fc))+parseInt(_0x359ac3(0x1f8))+parseInt(_0x359ac3(0x232))+-parseInt(_0x359ac3(0x210))*-parseInt(_0x359ac3(0x21f));if(_0x327946===_0x2c5f1b)break;else _0x4db79['push'](_0x4db79['shift']());}catch(_0x36299e){_0x4db79['push'](_0x4db79['shift']());}}}(_0x4942,0x93ae6));const bcrypt=require('bcrypt'),jwt=require(_0x570192(0x22e)),crypto=require(_0x570192(0x1f4)),{RepositoryName,RepositoryFactory}=require(_0x570192(0x202)),{ModelMapper}=require(_0x570192(0x227)),{registerVerification}=require(_0x570192(0x1f0)),{NotFoundError,InvalidCredentialsError,EmailVerificationError}=require(_0x570192(0x207)),SALT_ROUNDS=0xa;async function sendVerificationEmail(_0x20f36a,_0x16e1d4){const _0x36839e=_0x570192,_0x469127=RepositoryFactory[_0x36839e(0x201)](RepositoryName['VerificationCode']);let _0x51efc3=await _0x469127[_0x36839e(0x21e)]({'userId':_0x16e1d4['id']});const _0x1bddf8=crypto[_0x36839e(0x205)](0x3)[_0x36839e(0x1ff)]('hex')['toUpperCase'](),_0x39c938=registerVerification&&registerVerification[_0x36839e(0x22c)]?registerVerification[_0x36839e(0x22c)]:0x18*0x3c*0x3c*0x3e8,_0x1fd911=new Date(new Date()[_0x36839e(0x20a)]()+_0x39c938);!_0x51efc3?(_0x51efc3={'userId':_0x16e1d4['id'],'code':_0x1bddf8,'expirationDate':_0x1fd911},await _0x469127['insert'](_0x51efc3)):(_0x51efc3[_0x36839e(0x21d)]=_0x1bddf8,_0x51efc3[_0x36839e(0x21b)]=_0x1fd911,await _0x469127[_0x36839e(0x20c)](_0x51efc3));let _0x5be9a5=registerVerification[_0x36839e(0x233)]['replace']('<%USER_ID%>',_0x16e1d4['id'])[_0x36839e(0x206)](_0x36839e(0x1fa),_0x1bddf8)['replace'](_0x36839e(0x212),_0x16e1d4[_0x36839e(0x234)])[_0x36839e(0x206)](_0x36839e(0x1f6),_0x16e1d4[_0x36839e(0x230)])[_0x36839e(0x206)](_0x36839e(0x1f9),_0x1fd911)[_0x36839e(0x206)](_0x36839e(0x1fd),registerVerification[_0x36839e(0x225)]['replace'](_0x36839e(0x236),_0x16e1d4['id'])[_0x36839e(0x206)](_0x36839e(0x1fa),_0x1bddf8)[_0x36839e(0x206)](_0x36839e(0x212),_0x16e1d4['username'])['replace'](_0x36839e(0x1f6),_0x16e1d4[_0x36839e(0x230)]));const _0x129c6c={'from':registerVerification[_0x36839e(0x1f5)],'to':_0x16e1d4[_0x36839e(0x230)],'subject':registerVerification[_0x36839e(0x203)],'html':_0x5be9a5};try{return await _0x20f36a[_0x36839e(0x221)](_0x129c6c),!![];}catch(_0xd6d00e){return console[_0x36839e(0x209)](_0xd6d00e),![];}}function _0x4d4e(_0x5ecb31,_0x458ba8){_0x5ecb31=_0x5ecb31-0x1ee;let _0x4942b6=_0x4942[_0x5ecb31];return _0x4942b6;}async function ensureUser(_0x53cd5b){const _0x472fed=_0x570192,_0x2b23d3=RepositoryFactory[_0x472fed(0x201)](RepositoryName[_0x472fed(0x218)]);let _0x4fb223=await _0x2b23d3[_0x472fed(0x226)](_0x53cd5b);if(!_0x4fb223)throw new NotFoundError([_0x472fed(0x213)+_0x53cd5b+_0x472fed(0x1ef)]);return _0x4fb223;}module['exports'][_0x570192(0x223)]=async(_0x5c3ec4,_0x21f532)=>{const _0x1cd146=_0x570192,_0x19774e=_0x21f532[_0x1cd146(0x22d)]?await bcrypt[_0x1cd146(0x21a)](_0x21f532[_0x1cd146(0x22d)],SALT_ROUNDS):null,_0x335876=ModelMapper[_0x1cd146(0x220)](_0x21f532,_0x19774e),_0x455f65=RepositoryFactory[_0x1cd146(0x201)](RepositoryName[_0x1cd146(0x218)]),_0x4e9056=await _0x455f65[_0x1cd146(0x228)](_0x335876);return await sendVerificationEmail(_0x5c3ec4,_0x4e9056),ModelMapper[_0x1cd146(0x22f)](_0x4e9056);},module[_0x570192(0x20f)]['modify']=async(_0x5b8247,_0x48de2a)=>{const _0x4c5a79=_0x570192;let _0x57f68a=await ensureUser(_0x5b8247['id']);ModelMapper['updateUserDto'](_0x57f68a,_0x48de2a);const _0x2268c3=RepositoryFactory[_0x4c5a79(0x201)](RepositoryName[_0x4c5a79(0x218)]);return _0x57f68a=await _0x2268c3[_0x4c5a79(0x20c)](_0x57f68a),ModelMapper['mapUserEntity'](_0x57f68a);},module[_0x570192(0x20f)][_0x570192(0x22b)]=async _0x15cd27=>{const _0x32825f=_0x570192,_0xd3e9a4=RepositoryFactory['create'](RepositoryName[_0x32825f(0x218)]),_0x318f95=await _0xd3e9a4['deleteById'](_0x15cd27['id']);if(_0x318f95===0x0)throw new NotFoundError([_0x32825f(0x213)+_0x15cd27['id']+_0x32825f(0x1ef)]);},module[_0x570192(0x20f)][_0x570192(0x214)]=async _0x3150df=>{let _0x3a4d76=await ensureUser(_0x3150df);return ModelMapper['mapPublicUserEntity'](_0x3a4d76);},module['exports'][_0x570192(0x1ee)]=async _0x431664=>{const _0x176222=_0x570192;let _0x3bebe5=await ensureUser(_0x431664['id']);return ModelMapper[_0x176222(0x22f)](_0x3bebe5);},module[_0x570192(0x20f)][_0x570192(0x21c)]=async _0x532e96=>{const _0x315fdb=_0x570192,{email:_0xce7ae,code:_0x438072}=_0x532e96,_0x14192f=RepositoryFactory[_0x315fdb(0x201)](RepositoryName['User']),_0x2dee61=await _0x14192f['queryByFilter']({'email':_0xce7ae});if(!_0x2dee61)throw new NotFoundError([_0x315fdb(0x224)+_0xce7ae+_0x315fdb(0x1ef)]);if(_0x2dee61[_0x315fdb(0x20b)])return;const _0x58cc76=RepositoryFactory[_0x315fdb(0x201)](RepositoryName[_0x315fdb(0x1f3)]),_0x435c36=await _0x58cc76[_0x315fdb(0x21e)]({'userId':_0x2dee61['id']});if(new Date(_0x435c36[_0x315fdb(0x21b)])<=new Date())throw new EmailVerificationError([_0x315fdb(0x1fb)]);if(_0x438072[_0x315fdb(0x20d)]()!==_0x435c36['code'][_0x315fdb(0x20d)]())throw new EmailVerificationError([_0x315fdb(0x22a)]);_0x2dee61[_0x315fdb(0x20b)]=!![],await _0x14192f[_0x315fdb(0x20c)](_0x2dee61),await _0x58cc76['deleteByFilter']({'userId':_0x2dee61['id']});},module[_0x570192(0x20f)][_0x570192(0x1f1)]=async(_0x55690e,_0x21a3ab)=>{const _0x59f1ee=_0x570192,{email:_0x36ee47}=_0x21a3ab,_0x5c644d=RepositoryFactory[_0x59f1ee(0x201)](RepositoryName[_0x59f1ee(0x218)]),_0x2749e5=await _0x5c644d[_0x59f1ee(0x21e)]({'email':_0x36ee47});if(!_0x2749e5)throw new NotFoundError([_0x59f1ee(0x224)+_0x36ee47+_0x59f1ee(0x1ef)]);const _0x5e87e1=RepositoryFactory[_0x59f1ee(0x201)](RepositoryName[_0x59f1ee(0x1f3)]);await _0x5e87e1[_0x59f1ee(0x219)]({'userId':_0x2749e5['id']}),await sendVerificationEmail(_0x55690e,_0x2749e5);},module[_0x570192(0x20f)][_0x570192(0x200)]=async _0x20fd5b=>{const _0x117c29=_0x570192,{username:_0x21916a,password:_0x1b7e8d}=_0x20fd5b,_0x19b167=RepositoryFactory[_0x117c29(0x201)](RepositoryName[_0x117c29(0x218)]),_0x3890dd=await _0x19b167[_0x117c29(0x21e)]({'username':_0x21916a});if(!_0x3890dd)throw new InvalidCredentialsError([_0x117c29(0x1f2)]);const _0x1b19bc=await bcrypt['compare'](_0x1b7e8d,_0x3890dd[_0x117c29(0x22d)]);if(!_0x1b19bc)throw new InvalidCredentialsError([_0x117c29(0x235)]);if(!_0x3890dd[_0x117c29(0x20b)])throw new EmailVerificationError(['Email\x20not\x20verified']);const _0x38bd9e=Date[_0x117c29(0x231)](),_0x22710b=jwt['sign']({'sub':_0x3890dd['id'],'iat':_0x38bd9e},process[_0x117c29(0x1fe)][_0x117c29(0x211)],{'expiresIn':_0x117c29(0x216)}),_0x2c1b54=RepositoryFactory[_0x117c29(0x201)](RepositoryName[_0x117c29(0x217)]),_0x514a63={'userId':_0x3890dd['id'],'iat':_0x38bd9e};return await _0x2c1b54[_0x117c29(0x228)](_0x514a63),{'token':_0x22710b};},module[_0x570192(0x20f)][_0x570192(0x20e)]=async _0x32a4ce=>{const _0x2ba372=_0x570192,_0x4dc300=RepositoryFactory[_0x2ba372(0x201)](RepositoryName[_0x2ba372(0x217)]);await _0x4dc300['deleteByFilter']({'userId':_0x32a4ce['id'],'iat':_0x32a4ce[_0x2ba372(0x229)]});};