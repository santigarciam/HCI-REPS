'use strict';const _0x1c5f=['deleteByFilter','create','email','VerificationCode','map','sendMail','exports','mapUserEntity','691748fJilwa','57zssQQN','<%USERNAME%>','log_iat','User','1272878SWsMjZ','queryByFilter','queryById','login','subject','update','bcrypt','User\x20email\x20','toString','compare','201354JmMDID','toUpperCase','229zxnwdJ','hash','replace','Password\x20does\x20not\x20match','3701nisSoK','crypto','<%EXPIRATION_DATE%>','<%USER_ID%>','from','478788jFuzWn','getTime','../errors/errors','<%CONFIRM_LINK%>','../repository/RepositoryFactory','expirationDate','insert','confirmationLink','30d','mapPublicUserEntity','verified','Expired\x20verification\x20code','username','retrieveCurrent','queryByAdvancedFilter','randomBytes','659ascOMp','retrieve','codeExpirationInterval','Session','./ModelMapper','mapUserDto','password','Username\x20does\x20not\x20exist','../config/mailing','verifyEmail','logout','log','hex','code','594808zvdrMD','\x20not\x20found','jsonwebtoken','User\x20id\x20','resendVerificationEmail','modify','add','<%EMAIL%>'];const _0x237242=_0x42f3;(function(_0x2ec850,_0x496c72){const _0x26c97e=_0x42f3;while(!![]){try{const _0x432d1b=-parseInt(_0x26c97e(0x18d))+parseInt(_0x26c97e(0x19e))*parseInt(_0x26c97e(0x1b7))+-parseInt(_0x26c97e(0x19c))+parseInt(_0x26c97e(0x17d))+-parseInt(_0x26c97e(0x1a7))+parseInt(_0x26c97e(0x1a2))*-parseInt(_0x26c97e(0x18e))+parseInt(_0x26c97e(0x192));if(_0x432d1b===_0x496c72)break;else _0x2ec850['push'](_0x2ec850['shift']());}catch(_0x4fe560){_0x2ec850['push'](_0x2ec850['shift']());}}}(_0x1c5f,0x6a626));function _0x42f3(_0x10105a,_0x1dc8d8){_0x10105a=_0x10105a-0x170;let _0x1c5f37=_0x1c5f[_0x10105a];return _0x1c5f37;}const bcrypt=require(_0x237242(0x198)),jwt=require(_0x237242(0x17f)),crypto=require(_0x237242(0x1a3)),{RepositoryName,RepositoryFactory}=require(_0x237242(0x1ab)),{ModelMapper}=require(_0x237242(0x173)),{registerVerification}=require(_0x237242(0x177)),{NotFoundError,InvalidCredentialsError,EmailVerificationError}=require(_0x237242(0x1a9)),SALT_ROUNDS=0xa;async function sendVerificationEmail(_0x462acb,_0x286e6a){const _0x456d61=_0x237242,_0x4a03fa=RepositoryFactory[_0x456d61(0x186)](RepositoryName[_0x456d61(0x188)]);let _0x56f47d=await _0x4a03fa[_0x456d61(0x193)]({'userId':_0x286e6a['id']});const _0x418662=crypto[_0x456d61(0x1b6)](0x3)[_0x456d61(0x19a)](_0x456d61(0x17b))[_0x456d61(0x19d)](),_0x44e5a7=registerVerification&&registerVerification[_0x456d61(0x171)]?registerVerification[_0x456d61(0x171)]:0x18*0x3c*0x3c*0x3e8,_0x1d94a4=new Date(new Date()[_0x456d61(0x1a8)]()+_0x44e5a7);!_0x56f47d?(_0x56f47d={'userId':_0x286e6a['id'],'code':_0x418662,'expirationDate':_0x1d94a4},await _0x4a03fa[_0x456d61(0x1ad)](_0x56f47d)):(_0x56f47d['code']=_0x418662,_0x56f47d['expirationDate']=_0x1d94a4,await _0x4a03fa[_0x456d61(0x197)](_0x56f47d));let _0x5dfc85=registerVerification['htmlBodyTemplate'][_0x456d61(0x1a0)]('<%USER_ID%>',_0x286e6a['id'])[_0x456d61(0x1a0)]('<%CODE%>',_0x418662)[_0x456d61(0x1a0)](_0x456d61(0x18f),_0x286e6a['username'])[_0x456d61(0x1a0)]('<%EMAIL%>',_0x286e6a[_0x456d61(0x187)])[_0x456d61(0x1a0)](_0x456d61(0x1a4),_0x1d94a4)[_0x456d61(0x1a0)](_0x456d61(0x1aa),registerVerification[_0x456d61(0x1ae)][_0x456d61(0x1a0)](_0x456d61(0x1a5),_0x286e6a['id'])['replace']('<%CODE%>',_0x418662)[_0x456d61(0x1a0)](_0x456d61(0x18f),_0x286e6a[_0x456d61(0x1b3)])[_0x456d61(0x1a0)](_0x456d61(0x184),_0x286e6a[_0x456d61(0x187)]));const _0x19627f={'from':registerVerification[_0x456d61(0x1a6)],'to':_0x286e6a[_0x456d61(0x187)],'subject':registerVerification[_0x456d61(0x196)],'html':_0x5dfc85};try{return await _0x462acb[_0x456d61(0x18a)](_0x19627f),!![];}catch(_0x4e0e2e){return console[_0x456d61(0x17a)](_0x4e0e2e),![];}}async function ensureUser(_0x495b5a){const _0x8c1085=_0x237242,_0x4e13cb=RepositoryFactory['create'](RepositoryName['User']);let _0x4bb035=await _0x4e13cb[_0x8c1085(0x194)](_0x495b5a);if(!_0x4bb035)throw new NotFoundError([_0x8c1085(0x180)+_0x495b5a+_0x8c1085(0x17e)]);return _0x4bb035;}module[_0x237242(0x18b)][_0x237242(0x183)]=async(_0x1c16d2,_0x550ac6)=>{const _0x847e52=_0x237242,_0x22dc65=_0x550ac6[_0x847e52(0x175)]?await bcrypt[_0x847e52(0x19f)](_0x550ac6[_0x847e52(0x175)],SALT_ROUNDS):null,_0x23d582=ModelMapper[_0x847e52(0x174)](_0x550ac6,_0x22dc65),_0x1af113=RepositoryFactory['create'](RepositoryName[_0x847e52(0x191)]),_0x59f712=await _0x1af113['insert'](_0x23d582);return await sendVerificationEmail(_0x1c16d2,_0x59f712),ModelMapper[_0x847e52(0x18c)](_0x59f712);},module['exports'][_0x237242(0x182)]=async(_0x11f197,_0x26e915)=>{const _0x33c63a=_0x237242;let _0x2610b9=await ensureUser(_0x11f197['id']);ModelMapper['updateUserDto'](_0x2610b9,_0x26e915);const _0x4bc21c=RepositoryFactory[_0x33c63a(0x186)](RepositoryName['User']);return _0x2610b9=await _0x4bc21c[_0x33c63a(0x197)](_0x2610b9),ModelMapper['mapUserEntity'](_0x2610b9);},module[_0x237242(0x18b)]['remove']=async _0x50606a=>{const _0x1bd740=_0x237242,_0xcc5332=RepositoryFactory[_0x1bd740(0x186)](RepositoryName[_0x1bd740(0x191)]),_0x2e64a7=await _0xcc5332['deleteById'](_0x50606a['id']);if(_0x2e64a7===0x0)throw new NotFoundError([_0x1bd740(0x180)+_0x50606a['id']+_0x1bd740(0x17e)]);},module[_0x237242(0x18b)][_0x237242(0x170)]=async _0x71c11d=>{const _0x71fe6f=_0x237242;let _0x51e04e=await ensureUser(_0x71c11d);return ModelMapper[_0x71fe6f(0x1b0)](_0x51e04e);},module[_0x237242(0x18b)][_0x237242(0x1b4)]=async _0x32d302=>{let _0x529187=await ensureUser(_0x32d302['id']);return ModelMapper['mapUserEntity'](_0x529187);},module[_0x237242(0x18b)]['retrieveList']=async(_0x1f92bb,_0x248259,_0x3c5474,_0x4947de,_0x542f84)=>{const _0xf6e5db=_0x237242,_0x3e7cf2=_0x1f92bb?{'column':_0xf6e5db(0x1b3),'value':_0x1f92bb}:null,_0x20ecea=RepositoryFactory[_0xf6e5db(0x186)](RepositoryName[_0xf6e5db(0x191)]);let _0x519d9f=await _0x20ecea[_0xf6e5db(0x1b5)](null,_0x3e7cf2,_0x248259,_0x3c5474,_0x4947de,_0x542f84);return _0x519d9f['content']=_0x519d9f['content'][_0xf6e5db(0x189)](_0x17d3da=>ModelMapper[_0xf6e5db(0x1b0)](_0x17d3da)),_0x519d9f;},module[_0x237242(0x18b)][_0x237242(0x178)]=async _0x5ba8d7=>{const _0x15852d=_0x237242,{email:_0x2d2615,code:_0x194ea7}=_0x5ba8d7,_0x2eccc7=RepositoryFactory[_0x15852d(0x186)](RepositoryName[_0x15852d(0x191)]),_0x323989=await _0x2eccc7[_0x15852d(0x193)]({'email':_0x2d2615});if(!_0x323989)throw new NotFoundError([_0x15852d(0x199)+_0x2d2615+'\x20not\x20found']);if(_0x323989[_0x15852d(0x1b1)])return;const _0x222081=RepositoryFactory[_0x15852d(0x186)](RepositoryName['VerificationCode']),_0x11a7c8=await _0x222081['queryByFilter']({'userId':_0x323989['id']});if(new Date(_0x11a7c8[_0x15852d(0x1ac)])<=new Date())throw new EmailVerificationError([_0x15852d(0x1b2)]);if(_0x194ea7[_0x15852d(0x19d)]()!==_0x11a7c8[_0x15852d(0x17c)]['toUpperCase']())throw new EmailVerificationError(['Invalid\x20verification\x20code']);_0x323989[_0x15852d(0x1b1)]=!![],await _0x2eccc7['update'](_0x323989),await _0x222081[_0x15852d(0x185)]({'userId':_0x323989['id']});},module[_0x237242(0x18b)][_0x237242(0x181)]=async(_0x469c8e,_0x176174)=>{const _0x42a3e7=_0x237242,{email:_0x42278d}=_0x176174,_0xb27c11=RepositoryFactory[_0x42a3e7(0x186)](RepositoryName['User']),_0x4d2e41=await _0xb27c11['queryByFilter']({'email':_0x42278d});if(!_0x4d2e41)throw new NotFoundError([_0x42a3e7(0x199)+_0x42278d+_0x42a3e7(0x17e)]);const _0x1876c5=RepositoryFactory[_0x42a3e7(0x186)](RepositoryName['VerificationCode']);await _0x1876c5[_0x42a3e7(0x185)]({'userId':_0x4d2e41['id']}),await sendVerificationEmail(_0x469c8e,_0x4d2e41);},module['exports'][_0x237242(0x195)]=async _0x20b202=>{const _0x21dfbb=_0x237242,{username:_0x3613a1,password:_0x39a474}=_0x20b202,_0x5acfb9=RepositoryFactory['create'](RepositoryName['User']),_0x13bba7=await _0x5acfb9['queryByFilter']({'username':_0x3613a1});if(!_0x13bba7)throw new InvalidCredentialsError([_0x21dfbb(0x176)]);const _0x563cb4=await bcrypt[_0x21dfbb(0x19b)](_0x39a474,_0x13bba7[_0x21dfbb(0x175)]);if(!_0x563cb4)throw new InvalidCredentialsError([_0x21dfbb(0x1a1)]);if(!_0x13bba7['verified'])throw new EmailVerificationError(['Email\x20not\x20verified']);const _0x42afa5=Date['now'](),_0x1b8af4=jwt['sign']({'sub':_0x13bba7['id'],'iat':_0x42afa5},process['env']['JWT_SECRET'],{'expiresIn':_0x21dfbb(0x1af)}),_0xa3b684=RepositoryFactory[_0x21dfbb(0x186)](RepositoryName[_0x21dfbb(0x172)]),_0x1dfc5a={'userId':_0x13bba7['id'],'iat':_0x42afa5};return await _0xa3b684[_0x21dfbb(0x1ad)](_0x1dfc5a),{'token':_0x1b8af4};},module[_0x237242(0x18b)][_0x237242(0x179)]=async _0x23d8c2=>{const _0x36592a=_0x237242,_0xaed780=RepositoryFactory['create'](RepositoryName[_0x36592a(0x172)]);await _0xaed780['deleteByFilter']({'userId':_0x23d8c2['id'],'iat':_0x23d8c2[_0x36592a(0x190)]});};